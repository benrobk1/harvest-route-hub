# Contributing to Blue Harvests

Thank you for considering contributing to Blue Harvests! This guide will help you understand our codebase architecture and development workflow.

## Table of Contents

1. [Getting Started](#getting-started)
2. [Development Setup](#development-setup)
3. [Architecture Overview](#architecture-overview)
4. [Code Style Guidelines](#code-style-guidelines)
5. [Feature Development](#feature-development)
6. [Testing Requirements](#testing-requirements)
7. [Pull Request Process](#pull-request-process)
8. [Security Considerations](#security-considerations)

---

## Getting Started

Blue Harvests is a local food delivery marketplace built with:

- **Frontend**: React 18, TypeScript, Vite, TailwindCSS
- **Backend**: Supabase (PostgreSQL, Edge Functions, Auth, Storage)
- **Payments**: Stripe + Stripe Connect
- **State Management**: React Query (TanStack Query)
- **Testing**: Playwright (E2E), Vitest (unit tests)

### Prerequisites

- Node.js 18+ or Bun
- Git
- Supabase CLI (for local development)
- Stripe CLI (for webhook testing)

---

## Development Setup

### 1. Clone the Repository

```bash
git clone https://github.com/your-org/blue-harvests.git
cd blue-harvests
```

### 2. Install Dependencies

```bash
npm install
# or
bun install
```

### 3. Environment Setup

The `.env` file is auto-generated by Lovable Cloud. If running locally with your own Supabase:

```env
VITE_SUPABASE_URL=your_supabase_url
VITE_SUPABASE_PUBLISHABLE_KEY=your_anon_key
VITE_SUPABASE_PROJECT_ID=your_project_id
```

### 4. Database Setup

Apply migrations:

```bash
supabase db reset
```

Seed test data (optional):

```bash
npm run seed
```

### 5. Start Development Server

```bash
npm run dev
```

---

## Architecture Overview

### Folder Structure

```
src/
‚îú‚îÄ‚îÄ features/              # Feature modules (domain-driven design)
‚îÇ   ‚îú‚îÄ‚îÄ admin/            # Admin panel features
‚îÇ   ‚îú‚îÄ‚îÄ cart/             # Shopping cart
‚îÇ   ‚îú‚îÄ‚îÄ consumers/        # Consumer-facing features
‚îÇ   ‚îú‚îÄ‚îÄ drivers/          # Driver delivery features
‚îÇ   ‚îú‚îÄ‚îÄ farmers/          # Farmer inventory management
‚îÇ   ‚îú‚îÄ‚îÄ orders/           # Order processing
‚îÇ   ‚îú‚îÄ‚îÄ payouts/          # Financial payouts
‚îÇ   ‚îî‚îÄ‚îÄ products/         # Product catalog
‚îú‚îÄ‚îÄ components/           # Shared UI components
‚îÇ   ‚îú‚îÄ‚îÄ ui/              # shadcn/ui primitives
‚îÇ   ‚îî‚îÄ‚îÄ [feature]/       # Feature-specific components
‚îú‚îÄ‚îÄ pages/               # Route components
‚îú‚îÄ‚îÄ lib/                 # Utility functions
‚îú‚îÄ‚îÄ hooks/               # Shared React hooks
‚îú‚îÄ‚îÄ contexts/            # React contexts (Auth, etc.)
‚îú‚îÄ‚îÄ integrations/        # External integrations (Supabase)
‚îî‚îÄ‚îÄ config/              # App configuration

supabase/
‚îú‚îÄ‚îÄ functions/           # Edge functions (backend logic)
‚îÇ   ‚îî‚îÄ‚îÄ _shared/        # Shared services and middleware
‚îî‚îÄ‚îÄ migrations/         # Database migrations
```

### Feature Module Pattern

Each feature follows this structure:

```
features/[feature-name]/
‚îú‚îÄ‚îÄ components/       # Feature UI components
‚îú‚îÄ‚îÄ hooks/           # Feature-specific hooks
‚îú‚îÄ‚îÄ queries/         # React Query key factories
‚îú‚îÄ‚îÄ types/           # TypeScript types
‚îú‚îÄ‚îÄ errors.ts        # Error creators
‚îú‚îÄ‚îÄ index.ts         # Public exports
‚îî‚îÄ‚îÄ README.md        # Feature documentation
```

**Example:**

```typescript
// features/orders/index.ts
export * from './hooks/useActiveOrder';
export * from './queries';
export * from './types';
export * from './errors';
```

---

## Code Style Guidelines

### TypeScript

- **Strict mode compliance** - Code must compile with `strict` enabled; do not weaken tsconfig settings for convenience
- **Catch-all types are exceptional** - Avoid the untyped escape hatch. When unavoidable, document why it is needed and prefer narrower alternatives such as `unknown` plus type guards
- **Prefer explicit contracts** - Always add return types to exported functions/components and favor interfaces for object shapes
- **Readonly arrays** for query keys
- **Type safety first** - Guard against mixed runtime types (e.g., formatters that may receive numbers or strings) and keep data models aligned with platform types rather than loose records

```typescript
// ‚úÖ Good
export const orderQueries = {
  all: () => ['orders'] as const,
  active: (userId: string) => [...orderQueries.all(), 'active', userId] as const,
};

// ‚ùå Bad
export const orderQueries = {
  all: () => ['orders'],
  active: (userId: string) => ['orders', 'active', userId],
};
```

### React Patterns

- **Functional components only** - No class components
- **Custom hooks** for logic reuse
- **TanStack Query** for server state
- **Context API** for global state (auth, theme)

```typescript
// ‚úÖ Good - Custom hook with Query
export const useActiveOrder = () => {
  const { user } = useAuth();
  
  const { data, isLoading } = useQuery({
    queryKey: orderQueries.active(user?.id || ''),
    queryFn: async () => {
      const { data, error } = await supabase
        .from('orders')
        .select('*')
        .eq('consumer_id', user?.id);
      if (error) throw error;
      return data;
    },
    enabled: !!user?.id,
  });

  return { activeOrder: data, isLoading };
};
```

### Design System

- **Use semantic tokens** - Never hardcode colors
- **HSL color values** only
- **Tailwind CSS** for styling
- **shadcn/ui** for components

```tsx
// ‚úÖ Good - Semantic tokens
<button className="bg-primary text-primary-foreground hover:bg-primary/90">
  Submit
</button>

// ‚ùå Bad - Hardcoded colors
<button className="bg-blue-500 text-white hover:bg-blue-600">
  Submit
</button>
```

### Error Handling

- **Feature-specific errors** via error creators
- **Never throw raw strings** - Use error objects
- **Centralized error handling** via ErrorBoundary

```typescript
// ‚úÖ Good
import { createCheckoutError } from '@/features/orders';

throw createCheckoutError('Payment failed');

// ‚ùå Bad
throw new Error('Payment failed');
```

---

## Feature Development

### 1. Plan Your Feature

- Identify the domain (Admin, Consumer, Driver, Farmer, etc.)
- Define types in `types/index.ts`
- Create query keys in `queries/index.ts`
- Add error creators in `errors.ts`

### 2. Create Components

- Small, focused components
- Props interfaces with JSDoc
- Accessibility (ARIA labels, semantic HTML)
- Mobile-responsive by default

### 3. Add Business Logic

- Extract complex logic into hooks
- Use React Query for server state
- Add proper loading and error states
- Include optimistic updates where appropriate

### 4. Write Tests

- **E2E tests** for critical user flows (Playwright)
- **Unit tests** for utility functions (Vitest)
- **Integration tests** for hooks (React Testing Library)

```typescript
// e2e/checkout-flow.spec.ts
test('consumer can complete checkout', async ({ page }) => {
  await page.goto('/consumer/shop');
  await page.click('button:has-text("Add to Cart")');
  await page.click('text=Checkout');
  await page.fill('input[name="cardNumber"]', '4242424242424242');
  await page.click('button:has-text("Place Order")');
  await expect(page).toHaveURL(/order-success/);
});
```

### 5. Document Your Feature

- Add feature README following existing pattern
- Include usage examples
- Document all public APIs
- Explain business logic and edge cases

---

## Testing Requirements

### E2E Tests (Playwright)

Located in `e2e/` directory. Required for:

- Authentication flows
- Checkout process
- Order tracking
- Driver workflows
- Admin operations

Run tests:

```bash
npm run test:e2e
```

### Unit Tests (Vitest)

Located in `src/lib/__tests__/`. Required for:

- Utility functions
- Helper functions
- Business logic calculations

Run tests:

```bash
npm run test
```

### Coverage Requirements

- **Critical paths**: 90%+ coverage
- **Business logic**: 80%+ coverage
- **UI components**: Best effort

---

## Pull Request Process

### 1. Branch Naming

- `feature/order-tracking` - New features
- `fix/payment-error` - Bug fixes
- `refactor/cart-logic` - Code improvements
- `docs/api-reference` - Documentation

### 2. Commit Messages

Follow [Conventional Commits](https://www.conventionalcommits.org/):

```
feat(orders): add real-time order tracking
fix(checkout): prevent duplicate payment intents
refactor(cart): extract cart calculations to helper
docs(drivers): add route optimization documentation
```

### 3. PR Checklist

- [ ] Code follows style guidelines
- [ ] Tests added/updated
- [ ] Documentation updated
- [ ] No console errors or warnings
- [ ] Responsive design verified
- [ ] Accessibility checked
- [ ] Database migrations included (if applicable)
- [ ] Edge functions deployed (if applicable)

### 4. Review Process

1. Create PR with detailed description
2. Request review from maintainers
3. Address feedback
4. Squash and merge once approved

---

## Security Considerations

### Row-Level Security (RLS)

Always enable RLS on new tables:

```sql
ALTER TABLE my_table ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own data"
  ON my_table
  FOR SELECT
  USING (auth.uid() = user_id);
```

### Address Privacy System

Consumer addresses are **never** exposed to drivers until pickup confirmation. See [ARCHITECTURE.md](./ARCHITECTURE.md#address-privacy-system) for details.

### Environment Variables

- Never commit secrets to Git
- Use Supabase secrets management
- Prefix public vars with `VITE_`

### Payment Security

- **Server-side validation** for all prices
- **Stripe webhooks** for payment confirmation
- **Idempotency keys** for payment intents
- **Refund on order creation failure**

### Edge Function Auth

```typescript
// Verify JWT for protected endpoints
const authHeader = req.headers.get('Authorization');
if (!authHeader) {
  return new Response('Unauthorized', { status: 401 });
}

const { data: { user }, error } = await supabaseAuth.auth.getUser(token);
if (error || !user) {
  return new Response('Invalid token', { status: 401 });
}
```

---

## Common Tasks

### Adding a New Database Table

1. Create migration:
   ```sql
   -- supabase/migrations/YYYYMMDDHHMMSS_create_my_table.sql
   CREATE TABLE my_table (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     user_id UUID REFERENCES auth.users NOT NULL,
     created_at TIMESTAMPTZ DEFAULT now()
   );

   ALTER TABLE my_table ENABLE ROW LEVEL SECURITY;
   ```

2. Add RLS policies
3. Update `src/integrations/supabase/types.ts` (auto-generated)
4. Create queries in feature module

### Adding an Edge Function

1. Create function:
   ```bash
   mkdir supabase/functions/my-function
   touch supabase/functions/my-function/index.ts
   ```

2. Add to `supabase/config.toml`:
   ```toml
   [functions.my-function]
   verify_jwt = true
   ```

3. Deploy automatically via Lovable Cloud

### Adding a React Query Hook

```typescript
// features/my-feature/queries/index.ts
export const myFeatureQueries = {
  all: () => ['my-feature'] as const,
  list: () => [...myFeatureQueries.all(), 'list'] as const,
  detail: (id: string) => [...myFeatureQueries.all(), 'detail', id] as const,
};

// features/my-feature/hooks/useMyData.ts
export const useMyData = (id: string) => {
  return useQuery({
    queryKey: myFeatureQueries.detail(id),
    queryFn: async () => {
      const { data, error } = await supabase
        .from('my_table')
        .select('*')
        .eq('id', id)
        .single();
      if (error) throw error;
      return data;
    },
  });
};
```

---

## Resources

- [Architecture Documentation](./ARCHITECTURE.md)
- [Security Guidelines](./SECURITY.md)
- [API Reference](./API.md)
- [Migration Status](./MIGRATION-STATUS.md)
- [Supabase Documentation](https://supabase.com/docs)
- [React Query Documentation](https://tanstack.com/query/latest)
- [Stripe Connect Documentation](https://stripe.com/docs/connect)

---

## Questions?

- Open an issue on GitHub
- Join our Discord community
- Email: dev@blueharvests.com

Thank you for contributing! üéâ
